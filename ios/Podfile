# Uncomment this line to define a global platform for your project
platform :ios, '13.0'

# CocoaPods analytics sends network requests to Google Analytics. To disable
# this, uncomment the following line.
ENV['COCOAPODS_DISABLE_STATS'] = 'true'

# Uncomment this line to use a framework for the Pods project.
# use_frameworks!

def flutter_root
  defined_xcode_version = `xcodebuild -version | grep 'Xcode' | cut -d' ' -f2`.strip
  if defined_xcode_version.empty?
    abort "Error: Xcode not found or not installed."
  end
  
  # Find Flutter installation
  flutter_installation_path = nil
  ['/usr/local/bin', '/opt/homebrew/bin', ENV['PATH'].split(':')].flatten.each do |path|
    candidate = File.join(path, 'flutter')
    if File.exist?(candidate) && File.executable?(candidate)
      flutter_installation_path = File.dirname(candidate)
      break
    end
  end
  
  unless flutter_installation_path
    abort "Error: Flutter not found. Install Flutter or add it to PATH."
  end
  
  # Return Flutter SDK root directory (two levels up from bin/flutter)
  File.dirname(flutter_installation_path)
end

require File.join(flutter_root, 'packages', 'flutter_tools', 'bin', 'podhelper')

flutter_ios_podfile_setup

target 'Runner' do
  use_frameworks!
  use_modular_headers!

  flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      # Fix POD_CONFIGURATION_DEBUG macro redefinition
      config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] ||= ['$(inherited)']
      if config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'].include?('POD_CONFIGURATION_DEBUG=1')
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'].delete('POD_CONFIGURATION_DEBUG=1')
        config.build_settings['GCC_PREPROCESSOR_DEFINITIONS'] << 'POD_CONFIGURATION_DEBUG=1'
      end
      
      # Suppress warnings
      config.build_settings['GCC_WARN_INHIBIT_ALL_WARNINGS'] = 'YES'
      config.build_settings['CLANG_WARN_DOCUMENTATION_COMMENTS'] = 'NO'
      
      # Swift concurrency settings
      config.build_settings['SWIFT_STRICT_CONCURRENCY'] = 'minimal'
      config.build_settings['SWIFT_UPCOMING_FEATURE_CONCURRENCY_CHECKING'] = 'NO'
      
      # iOS deployment target
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.0'
      
      # Fix Flutter module linking for simulator builds
      if config.build_settings['PRODUCT_NAME'] != 'Flutter'
        config.build_settings['LIBRARY_SEARCH_PATHS'] ||= ['$(inherited)']
        config.build_settings['LIBRARY_SEARCH_PATHS'] << '$(TOOLCHAIN_DIR)/usr/lib/swift/$(PLATFORM_NAME)'
        config.build_settings['FRAMEWORK_SEARCH_PATHS'] ||= ['$(inherited)']
        config.build_settings['FRAMEWORK_SEARCH_PATHS'] << '$(PROJECT_DIR)/Flutter'
      end
    end
  end
end
